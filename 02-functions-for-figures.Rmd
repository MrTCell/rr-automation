
## What is a functions?

```
input --> function does something --> output
```

One of the main benefits of writing functions is to avoid repetition of your
code. In general, you should never repeat yourself when you write code.

Another advantage, it that your code is self contained and any variable that you
create inside a function will not be exported into your global environment.

## How to write functions in R

```{r}
## Fahrenheit to Celsius
(70 - 32) * 5/9
(65 - 32) * 5/9
(85 - 32) * 5/9
```

Let's convert this into a function:

```{r}
fahr_to_celsius <- function(temp) {
    (temp - 32) * 5/9
}
```

A little more complicated:

```{r}
convert_fahr <- function(temp, to) {
    res <- (temp - 32) * 5/9
    if (to == "kelvin") {
        res <- res + 273.15
    }
    res
}
```

With functions you can easily control the format of the input and avoid the
chances for typos or other small mistakes.

```{r}
convert_fahr <- function(temp, to = c("celsius", "kelvin")) {
    to <- tolower(to)
    to <- match.arg(to)
    res <- (temp - 32) * 5/9
    if (to == "kelvin") {
        res <- res + 273.15
    }
    res
}
```

Let's refactor this function into something even better:

```{r}
fahr_to_celsius <- function(temp) {
    (temp - 32) * 5/9
}

celsius_to_kelvin <- function(temp) {
    temp + 273.15
}

convert_fahr <- function(temp, to = c("celsius", "kelvin")) {
    to <- tolower(to)
    to <- match.arg(to)
    res <- fahr_to_celsius(temp)
    if (to == "kelvin") {
        res <- celsius_to_kelvin(res)
    }
    res
}
```

Your intentions are clear, everything is self contained, you can easily debug,
test and document each of the steps involved.


### Your turn

Write a function that converts pounds in kilograms (divides by 2.2). Stretch
goal and in grams.


## Writing functions to generate figures

Intro to Nile dataset

```{r, fig.show='hide'}
plot(Nile)
hist(Nile)
mean(Nile)
```

```{r, purl=TRUE, fig.show='hide'}
par(mfrow=c(1, 2))
plot(Nile)
abline(h = mean(Nile), col = "red", lwd = 3, lty = 2)
yrs <- attr(Nile, "tsp")
fit <- loess(Nile ~ seq(yrs[1], yrs[2], 1))
lines(seq(yrs[1], yrs[2]), fitted(fit), col = "blue", lwd = 2)
hist(Nile)
abline(v = mean(Nile), col = "red",  lwd = 3, lty = 2)
```

If we want to make a PDF file of this figure we could do:

```{r, eval=FALSE}
pdf(file="nile_flow.pdf", width=8, height=6)

par(mfrow=c(1, 2))
plot(Nile)
abline(h = mean(Nile), col = "red", lwd = 3, lty = 2)
yrs <- attr(Nile,  "tsp")
fit <- loess(Nile ~ seq(yrs[1], yrs[2], 1))
lines(seq(yrs[1], yrs[2]), fitted(fit), col = "blue", lwd = 2)
hist(Nile)
abline(v = mean(Nile), col = "red",  lwd = 3, lty = 2)

dev.off()
```

It's not very neat, as we end up with 2 variables that are global (`yrs` and
`fit`) that we probably won't need anywhere else.

Let's convert this into a function:

```{r}
fig_Nile <- function() {
    par(mfrow=c(1, 2))
    plot(Nile, cex = .7)
    abline(h = mean(Nile), col = "red", lwd = 3, lty = 2)
    yrs <- attr(Nile,  "tsp")
    fit <- loess(Nile ~ seq(yrs[1], yrs[2], 1))
    lines(seq(yrs[1], yrs[2]), fitted(fit), col = "blue", lwd = 2)
    hist(Nile, cex = .7)
    abline(v = mean(Nile), col = "red",  lwd = 3, lty = 2)
}
```

so this part gets a little prettier:

```{r, eval=FALSE}
pdf(file="nile_flow.pdf", width=6.5, height=4)
fig_Nile()
dev.off()
```

If you start making a lot of figures, it would be nice to have to repeat this
first and third lines...

Let's create another function that will automate this process:

```{r, purl=TRUE}
make_pdf <- function(expr,  filename, ..., verbose = TRUE) {
    if (verbose) {
        message("Creating: ", filename)
    }
    pdf(file = filename, ...)
    on.exit(dev.off())
    eval.parent(substitute(expr))
}
```

```{r}
make_pdf(fig_Nile(), "nile_flow.pdf", width = 6.5, height = 4)
```

## Your turn

```{r, purl=TRUE}

finland <- read.csv(file = "data-raw/Finland-gdp-percapita.csv")
japan <- read.csv(file="data-raw/Japan-gdp-percapita.csv")
plot(lifeExp ~ gdpPercap, data=finland, col="red")
fit_finland <- lm(lifeExp ~ gdpPercap, data=finland)
abline(fit_finland, col="red", lwd=3, lty=2)
points(japan$gdpPercap, japan$lifeExp, pch=2, col="blue")
fit_japan <- lm(lifeExp ~ gdpPercap, data=japan)
abline(fit_japan, col="blue", lwd=3, lty=2)

```
